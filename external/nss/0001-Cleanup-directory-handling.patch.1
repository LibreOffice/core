From ea780b38c320d2067ce3414179010088ee75ee9b Mon Sep 17 00:00:00 2001
From: Jan-Marek Glogowski <glogow@fbihome.de>
Date: Sun, 30 Jun 2019 15:22:09 +0000
Subject: [PATCH 1/7] Cleanup directory handling

* rename MAKE_OBJDIR to MAKE_DIR
* order-depend on OBJDIR
* never remove directories, if something else is there
---
 nspr/config/Makefile.in                       |   9 +-
 nspr/config/config.mk                         |   4 +-
 nspr/config/rules.mk                          |  31 +++---
 nspr/lib/ds/Makefile.in                       |   3 +-
 nspr/lib/libc/src/Makefile.in                 |   3 +-
 nspr/lib/prstreams/Makefile.in                |   3 +-
 .../prstreams/tests/testprstrm/Makefile.in    |   6 +-
 nspr/lib/tests/Makefile.in                    |   6 +-
 nspr/pr/src/Makefile.in                       |   3 +-
 nspr/pr/src/cplus/tests/Makefile.in           |   6 +-
 nspr/pr/src/md/windows/Makefile.in            |   3 +-
 nspr/pr/src/misc/Makefile.in                  |   3 +-
 nspr/pr/tests/Makefile.in                     |   6 +-
 nspr/tools/Makefile.in                        |   6 +-
 nss/coreconf/OS2.mk                           |   4 +-
 nss/coreconf/UNIX.mk                          |   4 +-
 nss/coreconf/WIN32.mk                         |   6 +-
 nss/coreconf/mkdepend/Makefile                |   6 +-
 nss/coreconf/nsinstall/Makefile               |   6 +-
 nss/coreconf/rules.mk                         | 101 +++++++-----------
 nss/gtests/common/gtest.mk                    |   2 +-
 nss/lib/ckfw/builtins/Makefile                |   3 +-
 nss/lib/ckfw/capi/Makefile                    |   3 +-
 nss/lib/dev/Makefile                          |   3 +-
 nss/lib/freebl/Makefile                       |  13 +--
 nss/lib/pk11wrap/Makefile                     |   3 +-
 nss/lib/softoken/Makefile                     |   6 +-
 27 files changed, 100 insertions(+), 152 deletions(-)

diff --git a/nspr/config/Makefile.in b/nspr/config/Makefile.in
index 7062c5c..4cb769e 100644
--- a/nspr/config/Makefile.in
+++ b/nspr/config/Makefile.in
@@ -96,9 +96,9 @@ OUTOPTION = -Fe
 endif
 endif
 
-# Redefine MAKE_OBJDIR for just this directory
-define MAKE_OBJDIR
-if test ! -d $(@D); then rm -rf $(@D); mkdir $(@D); else true; fi
+# Redefine MAKE_DIR for just this directory
+define MAKE_DIR
+if test ! -d $@; then $(NSINSTALL) -D $@; fi
 endef
 
 export:: $(TARGETS)
@@ -111,8 +111,7 @@ export::
 	$(INSTALL) system_wrappers $(dist_includedir)
 endif
 
-$(OBJDIR)/%$(PROG_SUFFIX): $(OBJDIR)/%.$(OBJ_SUFFIX)
-	@$(MAKE_OBJDIR)
+$(OBJDIR)/%$(PROG_SUFFIX): $(OBJDIR)/%.$(OBJ_SUFFIX) | $(OBJDIR)
 	$(CC) $(XCFLAGS) $< $(LDFLAGS) $(XLDOPTS) $(OUTOPTION)$@
 
 install:: nspr.m4
diff --git a/nspr/config/config.mk b/nspr/config/config.mk
index 05db076..9443575 100644
--- a/nspr/config/config.mk
+++ b/nspr/config/config.mk
@@ -63,8 +63,8 @@ endif
 endif # MOZ_PROFILE_USE
 endif # NO_PROFILE_GUIDED_OPTIMIZE
 
-define MAKE_OBJDIR
-if test ! -d $(@D); then rm -rf $(@D); $(NSINSTALL) -D $(@D); fi
+define MAKE_DIR
+if test ! -d $@; then $(NSINSTALL) -D $@; fi
 endef
 
 LINK_DLL	= $(LD) $(OS_DLLFLAGS) $(DLLFLAGS)
diff --git a/nspr/config/rules.mk b/nspr/config/rules.mk
index 1c8fdc9..a130718 100644
--- a/nspr/config/rules.mk
+++ b/nspr/config/rules.mk
@@ -62,6 +62,11 @@ endif
 endif
 endif
 
+ifdef OBJDIR
+$(OBJDIR)::
+	@$(MAKE_DIR)
+endif
+
 #
 # This makefile contains rules for building the following kinds of
 # libraries:
@@ -251,8 +256,7 @@ alltags:
 $(NFSPWD):
 	cd $(@D); $(MAKE) $(@F)
 
-$(PROGRAM): $(OBJS)
-	@$(MAKE_OBJDIR)
+$(PROGRAM): $(OBJS) | $(OBJDIR)
 ifeq ($(NS_USE_GCC)_$(OS_ARCH),_WINNT)
 ifdef MOZ_PROFILE_USE
 # In the second pass, we need to merge the pgc files into the pgd file.
@@ -280,14 +284,13 @@ ifdef ENABLE_STRIP
 	$(STRIP) $@
 endif
 
-$(LIBRARY): $(OBJS)
-	@$(MAKE_OBJDIR)
+$(LIBRARY): $(OBJS) | $(OBJDIR)
 	rm -f $@
 	$(AR) $(AR_FLAGS) $(OBJS) $(AR_EXTRA_ARGS)
 	$(RANLIB) $@
 
 ifeq ($(OS_TARGET), OS2)
-$(IMPORT_LIBRARY): $(MAPFILE)
+$(IMPORT_LIBRARY): $(MAPFILE) | $(OBJDIR)
 	rm -f $@
 	$(IMPLIB) $@ $(MAPFILE)
 else
@@ -299,8 +302,7 @@ $(SHARED_LIB_PDB): $(SHARED_LIBRARY)
 endif
 endif
 
-$(SHARED_LIBRARY): $(OBJS) $(RES) $(MAPFILE)
-	@$(MAKE_OBJDIR)
+$(SHARED_LIBRARY): $(OBJS) $(RES) $(MAPFILE) | $(OBJDIR)
 	rm -f $@
 ifeq ($(OS_ARCH)$(OS_RELEASE), AIX4.1)
 	echo "#!" > $(OBJDIR)/lib$(LIBRARY_NAME)_syms
@@ -376,8 +378,7 @@ endif
 ################################################################################
 
 ifeq ($(OS_ARCH),WINNT)
-$(RES): $(RESNAME)
-	@$(MAKE_OBJDIR)
+$(RES): $(RESNAME) | $(OBJDIR)
 # The resource compiler does not understand the -U option.
 ifdef NS_USE_GCC
 	$(RC) $(RCFLAGS) $(filter-out -U%,$(DEFINES)) $(INCLUDES:-I%=--include-dir %) -o $@ $<
@@ -387,8 +388,7 @@ endif # GCC
 	@echo $(RES) finished
 endif
 
-$(MAPFILE): $(LIBRARY_NAME).def
-	@$(MAKE_OBJDIR)
+$(MAPFILE): $(LIBRARY_NAME).def | $(OBJDIR)
 ifeq ($(OS_ARCH),SunOS)
 	grep -v ';-' $< | \
 	sed -e 's,;+,,' -e 's; DATA ;;' -e 's,;;,,' -e 's,;.*,;,' > $@
@@ -423,8 +423,7 @@ ifdef NEED_ABSOLUTE_PATH
 pr_abspath = "$(if $(findstring :,$(1)),$(1),$(if $(filter /%,$(1)),$(1),$(CURDIR)/$(1)))"
 endif
 
-$(OBJDIR)/%.$(OBJ_SUFFIX): %.cpp
-	@$(MAKE_OBJDIR)
+$(OBJDIR)/%.$(OBJ_SUFFIX): %.cpp | $(OBJDIR)
 ifeq ($(NS_USE_GCC)_$(OS_ARCH),_WINNT)
 	$(CCC) -Fo$@ -c $(CCCFLAGS) $(call pr_abspath,$<)
 else
@@ -442,8 +441,7 @@ endif
 WCCFLAGS1 = $(subst /,\\,$(CFLAGS))
 WCCFLAGS2 = $(subst -I,-i=,$(WCCFLAGS1))
 WCCFLAGS3 = $(subst -D,-d,$(WCCFLAGS2))
-$(OBJDIR)/%.$(OBJ_SUFFIX): %.c
-	@$(MAKE_OBJDIR)
+$(OBJDIR)/%.$(OBJ_SUFFIX): %.c | $(OBJDIR)
 ifeq ($(NS_USE_GCC)_$(OS_ARCH),_WINNT)
 	$(CC) -Fo$@ -c $(CFLAGS) $(call pr_abspath,$<)
 else
@@ -459,8 +457,7 @@ endif
 endif
 
 
-$(OBJDIR)/%.$(OBJ_SUFFIX): %.s
-	@$(MAKE_OBJDIR)
+$(OBJDIR)/%.$(OBJ_SUFFIX): %.s | $(OBJDIR)
 	$(AS) -o $@ $(ASFLAGS) -c $<
 
 %.i: %.c
diff --git a/nspr/lib/ds/Makefile.in b/nspr/lib/ds/Makefile.in
index e737791..317365a 100644
--- a/nspr/lib/ds/Makefile.in
+++ b/nspr/lib/ds/Makefile.in
@@ -112,8 +112,7 @@ endif
 
 GARBAGE += $(TINC)
 
-$(TINC):
-	@$(MAKE_OBJDIR)
+$(TINC): | $(OBJDIR)
 	@$(ECHO) '#define _BUILD_STRING "$(SH_DATE)"' > $(TINC)
 	@if test ! -z "$(SH_NOW)"; then \
 	    $(ECHO) '#define _BUILD_TIME $(SH_NOW)$(SUF)' >> $(TINC); \
diff --git a/nspr/lib/libc/src/Makefile.in b/nspr/lib/libc/src/Makefile.in
index e8a6d9f..98041ba 100644
--- a/nspr/lib/libc/src/Makefile.in
+++ b/nspr/lib/libc/src/Makefile.in
@@ -114,8 +114,7 @@ endif
 
 GARBAGE += $(TINC)
 
-$(TINC):
-	@$(MAKE_OBJDIR)
+$(TINC): | $(OBJDIR)
 	@$(ECHO) '#define _BUILD_STRING "$(SH_DATE)"' > $(TINC)
 	@if test ! -z "$(SH_NOW)"; then \
 	    $(ECHO) '#define _BUILD_TIME $(SH_NOW)$(SUF)' >> $(TINC); \
diff --git a/nspr/lib/prstreams/Makefile.in b/nspr/lib/prstreams/Makefile.in
index aeb2944..b44cbd1 100644
--- a/nspr/lib/prstreams/Makefile.in
+++ b/nspr/lib/prstreams/Makefile.in
@@ -114,8 +114,7 @@ else
 	SUF = LL
 endif
 
-$(TINC):
-	@$(MAKE_OBJDIR)
+$(TINC): | $(OBJDIR)
 	@$(ECHO) '#define _BUILD_STRING "$(SH_DATE)"' > $(TINC)
 	@if test ! -z "$(SH_NOW)"; then \
 	    $(ECHO) '#define _BUILD_TIME $(SH_NOW)$(SUF)' >> $(TINC); \
diff --git a/nspr/lib/prstreams/tests/testprstrm/Makefile.in b/nspr/lib/prstreams/tests/testprstrm/Makefile.in
index 1271f94..680a4e9 100644
--- a/nspr/lib/prstreams/tests/testprstrm/Makefile.in
+++ b/nspr/lib/prstreams/tests/testprstrm/Makefile.in
@@ -136,8 +136,7 @@ ifeq ($(AIX_PRE_4_2),1)
 # the .$(OBJ_SUFFIX) file from the .c source file, then do the
 # two-step linking hack below.
 
-$(OBJDIR)/%: $(OBJDIR)/%.$(OBJ_SUFFIX)
-	@$(MAKE_OBJDIR)
+$(OBJDIR)/%: $(OBJDIR)/%.$(OBJ_SUFFIX) | $(OBJDIR)
 	rm -f $@ $(AIX_TMP)
 	$(CC) $(AIX_LINK_OPTS) -o $(AIX_TMP) $< $(dist_libdir)/libnspr$(MOD_MAJOR_VERSION).a
 	$(CC) -o $@ $(AIX_TMP) $(AIX_WRAP)
@@ -147,8 +146,7 @@ else
 
 # All platforms that are not AIX pre-4.2.
 
-$(OBJDIR)/%$(PROG_SUFFIX): $(OBJDIR)/%.$(OBJ_SUFFIX)
-	@$(MAKE_OBJDIR)
+$(OBJDIR)/%$(PROG_SUFFIX): $(OBJDIR)/%.$(OBJ_SUFFIX) | $(OBJDIR)
 ifeq ($(OS_ARCH), WINNT)
 	link $(LDOPTS) $< $(LIBPR) $(LIBPRSTRMS) ws2_32.lib -out:$@
 else
diff --git a/nspr/lib/tests/Makefile.in b/nspr/lib/tests/Makefile.in
index d8f595f..ad57523 100644
--- a/nspr/lib/tests/Makefile.in
+++ b/nspr/lib/tests/Makefile.in
@@ -144,8 +144,7 @@ ifeq ($(AIX_PRE_4_2),1)
 # the .$(OBJ_SUFFIX) file from the .c source file, then do the
 # two-step linking hack below.
 
-$(OBJDIR)/%: $(OBJDIR)/%.$(OBJ_SUFFIX)
-	@$(MAKE_OBJDIR)
+$(OBJDIR)/%: $(OBJDIR)/%.$(OBJ_SUFFIX) | $(OBJDIR)
 	rm -f $@ $(AIX_TMP)
 	$(CC) $(AIX_LINK_OPTS) -o $(AIX_TMP) $< $(dist_libdir)/libnspr$(MOD_MAJOR_VERSION).a
 	$(CC) -o $@ $(AIX_TMP) $(AIX_WRAP)
@@ -155,8 +154,7 @@ else
 
 # All platforms that are not AIX pre-4.2.
 
-$(OBJDIR)/%$(PROG_SUFFIX): $(OBJDIR)/%.$(OBJ_SUFFIX)
-	@$(MAKE_OBJDIR)
+$(OBJDIR)/%$(PROG_SUFFIX): $(OBJDIR)/%.$(OBJ_SUFFIX) | $(OBJDIR)
 
 ifeq ($(OS_ARCH), WINNT)
 	link $(LDOPTS) $< $(LIBPLC) $(LIBPLDS) $(LIBPR) ws2_32.lib -out:$@
diff --git a/nspr/pr/src/Makefile.in b/nspr/pr/src/Makefile.in
index 671dea2..c6b0fcd 100644
--- a/nspr/pr/src/Makefile.in
+++ b/nspr/pr/src/Makefile.in
@@ -323,8 +323,7 @@ DEFINES		+= -D_NSPR_BUILD_
 
 GARBAGE += $(TINC)
 
-$(TINC):
-	@$(MAKE_OBJDIR)
+$(TINC): | $(OBJDIR)
 	@$(ECHO) '#define _BUILD_STRING "$(SH_DATE)"' > $(TINC)
 	@if test ! -z "$(SH_NOW)"; then \
 	    $(ECHO) '#define _BUILD_TIME $(SH_NOW)$(SUF)' >> $(TINC); \
diff --git a/nspr/pr/src/cplus/tests/Makefile.in b/nspr/pr/src/cplus/tests/Makefile.in
index c164238..390775c 100644
--- a/nspr/pr/src/cplus/tests/Makefile.in
+++ b/nspr/pr/src/cplus/tests/Makefile.in
@@ -175,8 +175,7 @@ ifeq ($(AIX_PRE_4_2),1)
 # the .$(OBJ_SUFFIX) file from the .c source file, then do the
 # two-step linking hack below.
 
-$(OBJDIR)/%: $(OBJDIR)/%.$(OBJ_SUFFIX)
-	@$(MAKE_OBJDIR)
+$(OBJDIR)/%: $(OBJDIR)/%.$(OBJ_SUFFIX) | $(OBJDIR)
 	rm -f $@ $(AIX_TMP)
 	$(CC) $(AIX_LINK_OPTS) -o $(AIX_TMP) $< $(dist_libdir)/libnspr$(MOD_MAJOR_VERSION).a
 	$(CC) -o $@ $(AIX_TMP) $(AIX_WRAP)
@@ -186,8 +185,7 @@ else
 
 # All platforms that are not AIX pre-4.2.
 
-$(OBJDIR)/%$(PROG_SUFFIX): $(OBJDIR)/%.$(OBJ_SUFFIX)
-	@$(MAKE_OBJDIR)
+$(OBJDIR)/%$(PROG_SUFFIX): $(OBJDIR)/%.$(OBJ_SUFFIX) | $(OBJDIR)
 ifeq ($(OS_ARCH), WINNT)
 ifeq ($(OS_TARGET),WIN16)
 	echo system windows         >w16link
diff --git a/nspr/pr/src/md/windows/Makefile.in b/nspr/pr/src/md/windows/Makefile.in
index 04bd716..cb1c809 100644
--- a/nspr/pr/src/md/windows/Makefile.in
+++ b/nspr/pr/src/md/windows/Makefile.in
@@ -64,8 +64,7 @@ export:: $(TARGETS)
 ifdef MOZ_OPTIMIZE
 ifeq ($(OS_TARGET), WINNT)
 ifndef NS_USE_GCC
-$(OBJDIR)/ntio.$(OBJ_SUFFIX): ntio.c
-	@$(MAKE_OBJDIR)
+$(OBJDIR)/ntio.$(OBJ_SUFFIX): ntio.c | $(OBJDIR)
 	$(CC) -Fo$@ -c $(CFLAGS) -Og- $<
 endif
 endif
diff --git a/nspr/pr/src/misc/Makefile.in b/nspr/pr/src/misc/Makefile.in
index 3d87da2..532e0f8 100644
--- a/nspr/pr/src/misc/Makefile.in
+++ b/nspr/pr/src/misc/Makefile.in
@@ -60,8 +60,7 @@ include $(topsrcdir)/config/rules.mk
 # could change the precision of floating-point calculations for
 # this single compilation unit.
 ifeq ($(NS_USE_GCC)_$(OS_ARCH),_WINNT)
-$(OBJDIR)/prdtoa.$(OBJ_SUFFIX): prdtoa.c
-	@$(MAKE_OBJDIR)
+$(OBJDIR)/prdtoa.$(OBJ_SUFFIX): prdtoa.c | $(OBJDIR)
 ifeq (,$(filter-out 1100 1200 1300 1310,$(MSC_VER)))
 	$(CC) -Fo$@ -c $(CFLAGS) -Op $(call pr_abspath,$<)
 else
diff --git a/nspr/pr/tests/Makefile.in b/nspr/pr/tests/Makefile.in
index 79a67f0..4123455 100644
--- a/nspr/pr/tests/Makefile.in
+++ b/nspr/pr/tests/Makefile.in
@@ -407,8 +407,7 @@ ifeq ($(AIX_PRE_4_2),1)
 # the .$(OBJ_SUFFIX) file from the .c source file, then do the
 # two-step linking hack below.
 
-$(OBJDIR)/%: $(OBJDIR)/%.$(OBJ_SUFFIX)
-	@$(MAKE_OBJDIR)
+$(OBJDIR)/%: $(OBJDIR)/%.$(OBJ_SUFFIX) | $(OBJDIR)
 	rm -f $@ $(AIX_TMP)
 	$(CC) $(AIX_LINK_OPTS) -o $(AIX_TMP) $< $(dist_libdir)/libnspr$(MOD_MAJOR_VERSION).a
 	$(CC) -o $@ $(AIX_TMP) $(AIX_WRAP)
@@ -418,8 +417,7 @@ else
 
 # All platforms that are not AIX pre-4.2.
 
-$(OBJDIR)/%$(PROG_SUFFIX): $(OBJDIR)/%.$(OBJ_SUFFIX)
-	@$(MAKE_OBJDIR)
+$(OBJDIR)/%$(PROG_SUFFIX): $(OBJDIR)/%.$(OBJ_SUFFIX) | $(OBJDIR)
 ifeq ($(NS_USE_GCC)_$(OS_ARCH),_WINNT)
 	link $(LDOPTS) $(EXTRA_LDOPTS) $< $(LIBPLC) $(LIBNSPR) $(EXTRA_LIBS) -out:$@
 ifdef MT
diff --git a/nspr/tools/Makefile.in b/nspr/tools/Makefile.in
index 38dd178..1ce6c8f 100644
--- a/nspr/tools/Makefile.in
+++ b/nspr/tools/Makefile.in
@@ -138,8 +138,7 @@ ifeq ($(AIX_PRE_4_2),1)
 # the .$(OBJ_SUFFIX) file from the .c source file, then do the
 # two-step linking hack below.
 
-$(OBJDIR)/%: $(OBJDIR)/%.$(OBJ_SUFFIX)
-	@$(MAKE_OBJDIR)
+$(OBJDIR)/%: $(OBJDIR)/%.$(OBJ_SUFFIX) | $(OBJDIR)
 	rm -f $@ $(AIX_TMP)
 	$(CC) $(AIX_LINK_OPTS) -o $(AIX_TMP) $< $(dist_libdir)/libnspr$(NSPR_VERSION).a
 	$(CC) -o $@ $(AIX_TMP) $(AIX_WRAP)
@@ -149,8 +148,7 @@ else
 
 # All platforms that are not AIX pre-4.2.
 
-$(OBJDIR)/%$(PROG_SUFFIX): $(OBJDIR)/%.$(OBJ_SUFFIX)
-	@$(MAKE_OBJDIR)
+$(OBJDIR)/%$(PROG_SUFFIX): $(OBJDIR)/%.$(OBJ_SUFFIX) | $(OBJDIR)
 ifeq ($(OS_ARCH), WINNT)
 ifeq ($(OS_TARGET),WIN16)
 	echo system windows >w16link
diff --git a/nss/coreconf/OS2.mk b/nss/coreconf/OS2.mk
index f23571c..00a9e51 100644
--- a/nss/coreconf/OS2.mk
+++ b/nss/coreconf/OS2.mk
@@ -130,8 +130,8 @@ else
 	endif
 endif
 
-define MAKE_OBJDIR
-if test ! -d $(@D); then rm -rf $(@D); $(NSINSTALL) -D $(@D); fi
+define MAKE_DIR
+if test ! -d $@; $(NSINSTALL) -D $@; fi
 endef
 
 #
diff --git a/nss/coreconf/UNIX.mk b/nss/coreconf/UNIX.mk
index b448e75..0e088d1 100644
--- a/nss/coreconf/UNIX.mk
+++ b/nss/coreconf/UNIX.mk
@@ -59,8 +59,8 @@ else
 	endif
 endif
 
-define MAKE_OBJDIR
-if test ! -d $(@D); then rm -rf $(@D); $(NSINSTALL) -D $(@D); fi
+define MAKE_DIR
+if test ! -d $@; then $(NSINSTALL) -D $@; fi
 endef
 
 include $(CORE_DEPTH)/coreconf/Werror.mk
diff --git a/nss/coreconf/WIN32.mk b/nss/coreconf/WIN32.mk
index 1556aaf..74b8a02 100644
--- a/nss/coreconf/WIN32.mk
+++ b/nss/coreconf/WIN32.mk
@@ -92,8 +92,6 @@ MKDEPEND        = $(MKDEPEND_DIR)/$(OBJDIR_NAME)/mkdepend.exe
 MKDEPENDENCIES  = $(OBJDIR_NAME)/depend.mk
 
 INSTALL      = $(NSINSTALL)
-MAKE_OBJDIR  = mkdir
-MAKE_OBJDIR += $(OBJDIR)
 GARBAGE     += $(OBJDIR)/vc20.pdb $(OBJDIR)/vc40.pdb
 XP_DEFINE   += -DXP_PC
 ifdef NS_USE_GCC
@@ -103,6 +101,10 @@ LIB_SUFFIX   = lib
 endif
 DLL_SUFFIX   = dll
 
+define MAKE_DIR
+if test ! -d $@; then mkdir -p $@; fi
+endef
+
 ifdef NS_USE_GCC
     OS_CFLAGS += -mwindows -mms-bitfields
     _GEN_IMPORT_LIB=-Wl,--out-implib,$(IMPORT_LIBRARY)
diff --git a/nss/coreconf/mkdepend/Makefile b/nss/coreconf/mkdepend/Makefile
index 4621f2a..e5b73e2 100644
--- a/nss/coreconf/mkdepend/Makefile
+++ b/nss/coreconf/mkdepend/Makefile
@@ -53,8 +53,8 @@ endif
 
 DEFINES += -DINCLUDEDIR=\"/usr/include\" -DOBJSUFFIX=\".$(OBJ_SUFFIX)\"
 
-# Redefine MAKE_OBJDIR for just this directory
-define MAKE_OBJDIR
-if test ! -d $(@D); then rm -rf $(@D); mkdir $(@D); fi
+# Redefine MAKE_DIR for just this directory
+define MAKE_DIR
+if test ! -d $@; then mkdir $@; fi
 endef
 
diff --git a/nss/coreconf/nsinstall/Makefile b/nss/coreconf/nsinstall/Makefile
index 1850bcb..1ec67f3 100644
--- a/nss/coreconf/nsinstall/Makefile
+++ b/nss/coreconf/nsinstall/Makefile
@@ -35,8 +35,8 @@ endif
 
 include $(DEPTH)/coreconf/rules.mk
 
-# Redefine MAKE_OBJDIR for just this directory
-define MAKE_OBJDIR
-if test ! -d $(@D); then rm -rf $(@D); mkdir $(@D); fi
+# Redefine MAKE_DIR for just this directory
+define MAKE_DIR
+@if test ! -d $@; then mkdir $@; fi
 endef
 
diff --git a/nss/coreconf/rules.mk b/nss/coreconf/rules.mk
index af66963..dfcc40d 100644
--- a/nss/coreconf/rules.mk
+++ b/nss/coreconf/rules.mk
@@ -28,6 +28,11 @@ ifeq (,$(filter-out _WIN%,$(NS_USE_GCC)_$(OS_TARGET)))
 USE_NT_C_SYNTAX=1
 endif
 
+ifdef OBJDIR
+$(OBJDIR):
+	@$(MAKE_DIR)
+endif
+
 #
 # IMPORTS will always be associated with a component.  Therefore,
 # the "import" rule will always change directory to the top-level
@@ -255,8 +260,7 @@ endif
 get_objs:
 	@echo $(OBJS)
 
-$(LIBRARY): $(OBJS)
-	@$(MAKE_OBJDIR)
+$(LIBRARY): $(OBJS) | $(OBJDIR)
 	rm -f $@
 ifeq (,$(filter-out _WIN%,$(NS_USE_GCC)_$(OS_TARGET)))
 	$(AR) $(OBJS)
@@ -285,8 +289,7 @@ SUB_SHLOBJS = $(foreach dir,$(SHARED_LIBRARY_DIRS),$(addprefix $(dir)/,$(shell $
 endif
 endif
 
-$(SHARED_LIBRARY): $(OBJS) $(RES) $(MAPFILE) $(SUB_SHLOBJS)
-	@$(MAKE_OBJDIR)
+$(SHARED_LIBRARY): $(OBJS) $(RES) $(MAPFILE) $(SUB_SHLOBJS) | $(OBJDIR)
 	rm -f $@
 ifeq ($(OS_TARGET)$(OS_RELEASE), AIX4.1)
 	echo "#!" > $(OBJDIR)/lib$(LIBRARY_NAME)_syms
@@ -316,8 +319,7 @@ endif
 endif
 
 ifeq (,$(filter-out WIN%,$(OS_TARGET)))
-$(RES): $(RESNAME)
-	@$(MAKE_OBJDIR)
+$(RES): $(RESNAME) | $(OBJDIR)
 # The resource compiler does not understand the -U option.
 ifdef NS_USE_GCC
 	$(RC) $(filter-out -U%,$(DEFINES)) $(INCLUDES:-I%=--include-dir %) -o $@ $<
@@ -327,13 +329,11 @@ endif
 	@echo $(RES) finished
 endif
 
-$(MAPFILE): $(MAPFILE_SOURCE)
-	@$(MAKE_OBJDIR)
+$(MAPFILE): $(MAPFILE_SOURCE) | $(OBJDIR)
 	$(PROCESS_MAP_FILE)
 
 
-$(OBJDIR)/$(PROG_PREFIX)%$(PROG_SUFFIX): $(OBJDIR)/$(PROG_PREFIX)%$(OBJ_SUFFIX)
-	@$(MAKE_OBJDIR)
+$(OBJDIR)/$(PROG_PREFIX)%$(PROG_SUFFIX): $(OBJDIR)/$(PROG_PREFIX)%$(OBJ_SUFFIX) | $(OBJDIR)
 ifeq (,$(filter-out _WIN%,$(NS_USE_GCC)_$(OS_TARGET)))
 	$(MKPROG) $< -Fe$@ -link \
 	$(LDFLAGS) $(XLDFLAGS) $(EXTRA_LIBS) $(EXTRA_SHARED_LIBS) $(OS_LIBS)
@@ -388,8 +388,7 @@ endif
 # The quotes allow absolute paths to contain spaces.
 core_abspath = '$(if $(findstring :,$(1)),$(1),$(if $(filter /%,$(1)),$(1),$(PWD)/$(1)))'
 
-$(OBJDIR)/$(PROG_PREFIX)%$(OBJ_SUFFIX): %.c
-	@$(MAKE_OBJDIR)
+$(OBJDIR)/$(PROG_PREFIX)%$(OBJ_SUFFIX): %.c | $(OBJDIR)
 ifdef USE_NT_C_SYNTAX
 	$(CC) -Fo$@ -c $(CFLAGS) $(call core_abspath,$<)
 else
@@ -412,21 +411,17 @@ endif
 endif
 
 ifneq (,$(filter-out _WIN%,$(NS_USE_GCC)_$(OS_TARGET)))
-$(OBJDIR)/$(PROG_PREFIX)%$(OBJ_SUFFIX): %.s
-	@$(MAKE_OBJDIR)
+$(OBJDIR)/$(PROG_PREFIX)%$(OBJ_SUFFIX): %.s | $(OBJDIR)
 	$(AS) -o $@ $(ASFLAGS) -c $<
 endif
 
-$(OBJDIR)/$(PROG_PREFIX)%$(OBJ_SUFFIX): %.asm
-	@$(MAKE_OBJDIR)
+$(OBJDIR)/$(PROG_PREFIX)%$(OBJ_SUFFIX): %.asm | $(OBJDIR)
 	$(AS) -Fo$@ $(ASFLAGS) -c $<
 
-$(OBJDIR)/$(PROG_PREFIX)%$(OBJ_SUFFIX): %.S
-	@$(MAKE_OBJDIR)
+$(OBJDIR)/$(PROG_PREFIX)%$(OBJ_SUFFIX): %.S | $(OBJDIR)
 	$(AS) -o $@ $(ASFLAGS) -c $<
 
-$(OBJDIR)/$(PROG_PREFIX)%: %.cpp
-	@$(MAKE_OBJDIR)
+$(OBJDIR)/$(PROG_PREFIX)%: %.cpp | $(OBJDIR)
 ifdef USE_NT_C_SYNTAX
 	$(CCC) -Fo$@ -c $(CFLAGS) $(CXXFLAGS) $(call core_abspath,$<)
 else
@@ -440,8 +435,7 @@ endif
 #
 # Please keep the next two rules in sync.
 #
-$(OBJDIR)/$(PROG_PREFIX)%$(OBJ_SUFFIX): %.cc
-	$(MAKE_OBJDIR)
+$(OBJDIR)/$(PROG_PREFIX)%$(OBJ_SUFFIX): %.cc | $(OBJDIR)
 ifdef STRICT_CPLUSPLUS_SUFFIX
 	echo "#line 1 \"$<\"" | cat - $< > $(OBJDIR)/t_$*.cc
 	$(CCC) -o $@ -c $(CFLAGS) $(CXXFLAGS) $(OBJDIR)/t_$*.cc
@@ -458,8 +452,7 @@ endif
 endif
 endif #STRICT_CPLUSPLUS_SUFFIX
 
-$(OBJDIR)/$(PROG_PREFIX)%$(OBJ_SUFFIX): %.cpp
-	@$(MAKE_OBJDIR)
+$(OBJDIR)/$(PROG_PREFIX)%$(OBJ_SUFFIX): %.cpp | $(OBJDIR)
 ifdef STRICT_CPLUSPLUS_SUFFIX
 	echo "#line 1 \"$<\"" | cat - $< > $(OBJDIR)/t_$*.cc
 	$(CCC) -o $@ -c $(CFLAGS) $(CXXFLAGS) $(OBJDIR)/t_$*.cc
@@ -502,11 +495,7 @@ endif
 ################################################################################
 
 $(JAVA_DESTPATH) $(JAVA_DESTPATH)/$(PACKAGE) $(JMCSRCDIR)::
-	@if test ! -d $@; then	    \
-		echo Creating $@;   \
-		rm -rf $@;	    \
-		$(NSINSTALL) -D $@; \
-	fi
+	@$(MAKE_DIR)
 
 ################################################################################
 ## IDL_GEN
@@ -748,8 +737,7 @@ $(JMC_GEN_DIR)/M%.h: $(JMCSRCDIR)/%.class
 $(JMC_GEN_DIR)/M%.c: $(JMCSRCDIR)/%.class
 	$(JMC) -d $(JMC_GEN_DIR) -module $(JMC_GEN_FLAGS) $(?F:.class=)
 
-$(OBJDIR)/M%$(OBJ_SUFFIX): $(JMC_GEN_DIR)/M%.c $(JMC_GEN_DIR)/M%.h
-	@$(MAKE_OBJDIR)
+$(OBJDIR)/M%$(OBJ_SUFFIX): $(JMC_GEN_DIR)/M%.c $(JMC_GEN_DIR)/M%.h | $(OBJDIR)
 	$(CC) -o $@ -c $(CFLAGS) $<
 
 export:: $(JMC_HEADERS) $(JMC_STUBS)
@@ -762,17 +750,14 @@ endif
 PUBLIC_EXPORT_DIR = $(SOURCE_XP_DIR)/public/$(MODULE)
 
 ifneq ($(EXPORTS),)
-$(PUBLIC_EXPORT_DIR)::
-	@if test ! -d $@; then	    \
-		echo Creating $@;   \
-		$(NSINSTALL) -D $@; \
-	fi
-
-export:: $(PUBLIC_EXPORT_DIR) 
+$(PUBLIC_EXPORT_DIR):
+	@$(MAKE_DIR)
 
-export:: $(EXPORTS) 
+$(PUBLIC_EXPORT_DIR)/%: %
 	$(INSTALL) -m 444 $^ $(PUBLIC_EXPORT_DIR)
 
+export:: $(addprefix $(PUBLIC_EXPORT_DIR)/,$(EXPORTS)) | $(PUBLIC_EXPORT_DIR)
+
 export:: $(BUILT_SRCS)
 endif
 
@@ -781,16 +766,13 @@ endif
 PRIVATE_EXPORT_DIR = $(SOURCE_XP_DIR)/private/$(MODULE)
 
 ifneq ($(PRIVATE_EXPORTS),)
-$(PRIVATE_EXPORT_DIR)::
-	@if test ! -d $@; then	    \
-		echo Creating $@;   \
-		$(NSINSTALL) -D $@; \
-	fi
-
-private_export:: $(PRIVATE_EXPORT_DIR)
+$(PRIVATE_EXPORT_DIR):
+	@$(MAKE_DIR)
 
-private_export:: $(PRIVATE_EXPORTS) 
+$(PRIVATE_EXPORT_DIR)/%: %
 	$(INSTALL) -m 444 $^ $(PRIVATE_EXPORT_DIR)
+
+private_export:: $(addprefix $(PRIVATE_EXPORT_DIR)/,$(PRIVATE_EXPORTS)) | $(PRIVATE_EXPORT_DIR)
 else
 private_export:: 
 	@echo There are no private exports.;
@@ -810,13 +792,12 @@ ifneq ($(BUILD_OPT),)
 REGDATE = $(subst \ ,, $(shell $(PERL)  $(CORE_DEPTH)/$(MODULE)/scripts/now))
 endif
 
-tests:: $(REGRESSION_SPEC) 
+$(TESTS_DIR)::
+	@$(MAKE_DIR)
+
+tests:: $(REGRESSION_SPEC) | $(TESTS_DIR)
 	cd $(PLATFORM); \
-	../$(SOURCE_MD_DIR)/bin/regress$(PROG_SUFFIX) specfile=../$(REGRESSION_SPEC) progress $(EXTRA_REGRESS_OPTIONS); \
-	if test ! -d $(TESTS_DIR); then \
-		echo Creating $(TESTS_DIR);   \
-		$(NSINSTALL) -D $(TESTS_DIR); \
-	fi
+	../$(SOURCE_MD_DIR)/bin/regress$(PROG_SUFFIX) specfile=../$(REGRESSION_SPEC) progress $(EXTRA_REGRESS_OPTIONS)
 ifneq ($(BUILD_OPT),)
 	$(NSINSTALL) -m 664 $(PLATFORM)/$(REGDATE).sum $(TESTS_DIR); \
 	$(NSINSTALL) -m 664 $(PLATFORM)/$(REGDATE).htm $(TESTS_DIR); \
@@ -833,14 +814,9 @@ endif
 
 ifneq ($(EXPORTS),)
 $(SOURCE_RELEASE_XP_DIR)/include::
-	@if test ! -d $@; then	    \
-		echo Creating $@;   \
-		$(NSINSTALL) -D $@; \
-	fi
-
-release_export:: $(SOURCE_RELEASE_XP_DIR)/include
+	@$(MAKE_DIR)
 
-release_export:: $(EXPORTS)
+release_export:: $(EXPORTS) | $(SOURCE_RELEASE_XP_DIR)/include
 	$(INSTALL) -m 444 $^ $(SOURCE_RELEASE_XP_DIR)/include
 endif
 
@@ -894,8 +870,7 @@ ifdef MKDEPENDENCIES
 
 # For Windows, $(MKDEPENDENCIES) must be -included before including rules.mk
 
-$(MKDEPENDENCIES)::
-	@$(MAKE_OBJDIR)
+$(MKDEPENDENCIES):: | $(OBJDIR)
 	touch $(MKDEPENDENCIES) 
 	chmod u+w $(MKDEPENDENCIES) 
 #on NT, the preceding touch command creates a read-only file !?!?!
@@ -966,5 +941,5 @@ $(filter $(OBJDIR)/%$(OBJ_SUFFIX),$(OBJS)): $(OBJDIR)/%$(OBJ_SUFFIX): $(DUMMY_DE
 # Fake targets.  Always run these rules, even if a file/directory with that
 # name already exists.
 #
-.PHONY: all all_platforms alltags boot clean clobber clobber_all export install libs program realclean release $(OBJDIR)
+.PHONY: all all_platforms alltags boot clean clobber clobber_all export install libs program realclean release
 
diff --git a/nss/gtests/common/gtest.mk b/nss/gtests/common/gtest.mk
index ecb324e..c25084b 100644
--- a/nss/gtests/common/gtest.mk
+++ b/nss/gtests/common/gtest.mk
@@ -30,7 +30,7 @@ ifeq (WINNT,$(OS_ARCH))
 
     # On windows, we need to create the parent directory
     # Needed because we include files from a subdirectory
-    MAKE_OBJDIR = $(INSTALL) -D $(dir $@)
+    MAKE_DIR = $(INSTALL) -D $(dir $@)
 else
     CXXFLAGS += -std=c++0x
 endif
diff --git a/nss/lib/ckfw/builtins/Makefile b/nss/lib/ckfw/builtins/Makefile
index 22726e2..e1d8a62 100644
--- a/nss/lib/ckfw/builtins/Makefile
+++ b/nss/lib/ckfw/builtins/Makefile
@@ -49,6 +49,5 @@ ifndef NSS_CERTDATA_TXT
 NSS_CERTDATA_TXT = certdata.txt
 endif
 
-$(OBJDIR)/certdata.c: $(NSS_CERTDATA_TXT) certdata.perl
-	@$(MAKE_OBJDIR)
+$(OBJDIR)/certdata.c: $(NSS_CERTDATA_TXT) certdata.perl | $(OBJDIR)
 	$(PERL) certdata.perl $(NSS_CERTDATA_TXT) $@
diff --git a/nss/lib/ckfw/capi/Makefile b/nss/lib/ckfw/capi/Makefile
index 81780d2..73300ca 100644
--- a/nss/lib/ckfw/capi/Makefile
+++ b/nss/lib/ckfw/capi/Makefile
@@ -60,8 +60,7 @@ DSO_LDOPTS              = -bM:SRE -bh:4 -bnoentry
 EXTRA_DSO_LDOPTS        = -lc
 MKSHLIB                 = xlC $(DSO_LDOPTS)
 
-$(SHARED_LIBRARY): $(OBJS)
-	@$(MAKE_OBJDIR)
+$(SHARED_LIBRARY): $(OBJS) | $(OBJDIR)
 	rm -f $@
 	$(MKSHLIB) -o $@ $(OBJS) $(EXTRA_LIBS) $(EXTRA_DSO_LDOPTS)
 	chmod +x $@
diff --git a/nss/lib/dev/Makefile b/nss/lib/dev/Makefile
index d88eb28..f59ba10 100644
--- a/nss/lib/dev/Makefile
+++ b/nss/lib/dev/Makefile
@@ -14,8 +14,7 @@ include $(CORE_DEPTH)/coreconf/rules.mk
 ifeq ($(OS_TARGET)$(OS_RELEASE),AIX4.3)
 ifeq ($(USE_64),1)
 ifndef BUILD_OPT
-$(OBJDIR)/ckhelper.o: ckhelper.c
-	@$(MAKE_OBJDIR)
+$(OBJDIR)/ckhelper.o: ckhelper.c | $(OBJDIR)
 	$(CC) -o $@ -c -O2 $(CFLAGS) $<
 endif
 endif
diff --git a/nss/lib/freebl/Makefile b/nss/lib/freebl/Makefile
index bff11c7..a1a6e48 100644
--- a/nss/lib/freebl/Makefile
+++ b/nss/lib/freebl/Makefile
@@ -600,12 +600,10 @@ $(OBJDIR)/ldvector$(OBJ_SUFFIX) $(OBJDIR)/loader$(OBJ_SUFFIX) : loader.h
 
 ifeq ($(SYSV_SPARC),1)
 
-$(OBJDIR)/mpv_sparcv8.o $(OBJDIR)/mpv_sparcv8x.o $(OBJDIR)/montmulfv8.o : $(OBJDIR)/%.o : %.s
-	@$(MAKE_OBJDIR)
+$(OBJDIR)/mpv_sparcv8.o $(OBJDIR)/mpv_sparcv8x.o $(OBJDIR)/montmulfv8.o : $(OBJDIR)/%.o : %.s | $(OBJDIR)
 	$(SOLARIS_AS) -o $@ $(SOLARIS_AS_FLAGS) $<
 
-$(OBJDIR)/mpv_sparcv9.o $(OBJDIR)/montmulfv9.o : $(OBJDIR)/%.o : %.s
-	@$(MAKE_OBJDIR)
+$(OBJDIR)/mpv_sparcv9.o $(OBJDIR)/montmulfv9.o : $(OBJDIR)/%.o : %.s | $(OBJDIR)
 	$(SOLARIS_AS) -o $@ $(SOLARIS_AS_FLAGS) $<
 
 $(OBJDIR)/mpmontg.o: mpmontg.c montmulf.h
@@ -636,9 +634,9 @@ ifdef NEED_STUB_BUILD
 SINGLE_SHLIB_DIR = $(OBJDIR)/$(OS_TARGET)_SINGLE_SHLIB
 ALL_TRASH += $(SINGLE_SHLIB_DIR) 
 $(SINGLE_SHLIB_DIR):
-	-mkdir $(SINGLE_SHLIB_DIR)
+	@$(MAKE_DIR)
 
-release_md libs:: $(SINGLE_SHLIB_DIR)
+release_md libs:: | $(SINGLE_SHLIB_DIR)
 	$(MAKE) FREEBL_CHILD_BUILD=1 USE_STUB_BUILD=1 \
  OBJDIR=$(SINGLE_SHLIB_DIR) $@
 endif
@@ -721,8 +719,7 @@ endif  # FREEBL_CHILD_BUILD
 # ANSI C's strict aliasing rules.
 ifeq ($(OS_TARGET),Linux)
 ifneq ($(CPU_ARCH),x86)
-$(OBJDIR)/$(PROG_PREFIX)desblapi$(OBJ_SUFFIX): desblapi.c
-	@$(MAKE_OBJDIR)
+$(OBJDIR)/$(PROG_PREFIX)desblapi$(OBJ_SUFFIX): desblapi.c | $(OBJDIR)
 ifdef NEED_ABSOLUTE_PATH
 	$(CC) -o $@ -c $(CFLAGS) -fno-strict-aliasing $(call core_abspath,$<)
 else
diff --git a/nss/lib/pk11wrap/Makefile b/nss/lib/pk11wrap/Makefile
index 86ab296..67642eb 100644
--- a/nss/lib/pk11wrap/Makefile
+++ b/nss/lib/pk11wrap/Makefile
@@ -54,8 +54,7 @@ $(OBJDIR)/pk11load$(OBJ_SUFFIX): debug_module.c
 ifeq ($(OS_TARGET)$(OS_RELEASE),AIX4.3)
 ifeq ($(USE_64),1)
 ifndef BUILD_OPT
-$(OBJDIR)/pk11slot.o: pk11slot.c
-	@$(MAKE_OBJDIR)
+$(OBJDIR)/pk11slot.o: pk11slot.c | $(OBJDIR)
 	$(CC) -o $@ -c -O2 $(CFLAGS) $<
 endif
 endif
diff --git a/nss/lib/softoken/Makefile b/nss/lib/softoken/Makefile
index 90a9da2..f96e89a 100644
--- a/nss/lib/softoken/Makefile
+++ b/nss/lib/softoken/Makefile
@@ -67,11 +67,9 @@ $(SHARED_LIBRARY): $(CRYPTOLIB)
 ifeq ($(OS_TARGET)$(OS_RELEASE),AIX4.3)
 ifeq ($(USE_64),1)
 ifndef BUILD_OPT
-$(OBJDIR)/pkcs11.o: pkcs11.c
-	@$(MAKE_OBJDIR)
+$(OBJDIR)/pkcs11.o: pkcs11.c | $(OBJDIR)
 	$(CC) -o $@ -c -O2 $(CFLAGS) $<
-$(OBJDIR)/pkcs11c.o: pkcs11c.c
-	@$(MAKE_OBJDIR)
+$(OBJDIR)/pkcs11c.o: pkcs11c.c | $(OBJDIR)
 	$(CC) -o $@ -c -O2 $(CFLAGS) $<
 endif
 endif
-- 
2.20.1

