From 4960b231f67eb86e5f6d6a79154c15268c959b34 Mon Sep 17 00:00:00 2001
From: Miklos Vajna <vmiklos@collabora.co.uk>
Date: Fri, 4 Mar 2016 16:10:16 +0100
Subject: [PATCH] xmlsec1-noverify.patch

Conflicts:
	src/mscrypto/x509vfy.c
	src/nss/x509vfy.c
---
 src/mscrypto/x509vfy.c | 12 ++++++++----
 src/nss/x509vfy.c      | 24 ++++++++++--------------
 2 files changed, 18 insertions(+), 18 deletions(-)

diff --git a/src/mscrypto/x509vfy.c b/src/mscrypto/x509vfy.c
index e4a84a60..a12cb709 100644
--- a/src/mscrypto/x509vfy.c
+++ b/src/mscrypto/x509vfy.c
@@ -525,10 +525,14 @@ xmlSecMSCryptoX509StoreVerify(xmlSecKeyDataStorePtr store, HCERTSTORE certs,
         }
 
         if(selected == 1) {
-	    if((keyInfoCtx->flags & XMLSEC_KEYINFO_FLAGS_X509DATA_DONT_VERIFY_CERTS) != 0
-               || xmlSecMSCryptoX509StoreConstructCertsChain(store, cert, certs, keyInfoCtx)) {
-                return(cert);
-            }
+        /* JL: OpenOffice.org implements its own certificate verification routine. 
+           The goal is to separate validation of the signature
+           and the certificate. For example, OOo could show that the document signature is valid,
+           but the certificate could not be verified. If we do not prevent the verification of
+           the certificate by libxmlsec and the verification fails, then the XML signature will not be 
+           verified. This would happen, for example, if the root certificate is not installed.                
+         */
+            return(cert);
         }
     }
 
diff --git a/src/nss/x509vfy.c b/src/nss/x509vfy.c
index cd328fea..b28a37e1 100644
--- a/src/nss/x509vfy.c
+++ b/src/nss/x509vfy.c
@@ -213,20 +213,16 @@ xmlSecNssX509StoreVerify(xmlSecKeyDataStorePtr store, CERTCertList* certs,
             continue;
         }
 
-        if((keyInfoCtx->flags & XMLSEC_KEYINFO_FLAGS_X509DATA_DONT_VERIFY_CERTS) == 0) {
-            /* it's important to set the usage here, otherwise no real verification
-             * is performed. */
-            status = CERT_VerifyCertificate(CERT_GetDefaultCertDB(),
-                                            cert, PR_FALSE,
-                                            certificateUsageEmailSigner,
-                                            timeboundary , NULL, NULL, NULL);
-            if(status == SECSuccess) {
-                break;
-            }
-        } else {
-            status = SECSuccess;
-            break;
-        }
+       /*
+      JL: OpenOffice.org implements its own certificate verification routine. 
+      The goal is to separate validation of the signature
+      and the certificate. For example, OOo could show that the document signature is valid,
+      but the certificate could not be verified. If we do not prevent the verification of
+      the certificate by libxmlsec and the verification fails, then the XML signature may not be 
+      verified. This would happen, for example, if the root certificate is not installed.
+    */
+        status = SECSuccess;
+        break;
     }
 
     if (status == SECSuccess) {
-- 
2.12.0

